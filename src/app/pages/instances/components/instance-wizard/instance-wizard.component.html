<ix-page-header [pageTitle]="pageTitle()">
  @if (!(hasRequiredRoles | async)) {
    <ix-readonly-badge></ix-readonly-badge>
  }
</ix-page-header>

<div class="container">
  <form class="form" [formGroup]="form" (submit)="onSubmit()">
    <ix-form-section
      [label]="'Basic Configuration' | translate"
    >
      <ix-input
        formControlName="name"
        [label]="'Name' | translate"
        [required]="true"
        [tooltip]="'Container name' | translate"
      ></ix-input>

      @if (!isEditMode()) {
        <ix-select
          formControlName="pool"
          [label]="'Pool' | translate"
          [required]="true"
          [tooltip]="'Pool to use for this container' | translate"
          [options]="poolOptions$"
        ></ix-select>
      }

      <ix-input
        formControlName="description"
        [label]="'Description' | translate"
        [tooltip]="'Container description' | translate"
      ></ix-input>

      <ix-checkbox
        formControlName="autostart"
        [label]="'Autostart' | translate"
        [tooltip]="'Automatically start the container on boot' | translate"
      ></ix-checkbox>

      @if (!isEditMode()) {
        <div class="image-field">
          <ix-input
            class="input"
            formControlName="image"
            [readonly]="true"
            [label]="'Image' | translate"
            [required]="true"
          ></ix-input>

          <button
            mat-button
            ixTest="browse-images"
            type="button"
            (click)="onBrowseCatalogImages()"
          >{{ 'Browse Catalog' | translate }}</button>
        </div>
      }
    </ix-form-section>

    <ix-form-section
      [label]="'CPU Configuration' | translate"
    >
      <ix-input
        formControlName="vcpus"
        type="number"
        [label]="'Virtual CPUs' | translate"
        [tooltip]="'Number of virtual CPUs (greater or equal to 1)' | translate"
      ></ix-input>

      <ix-input
        formControlName="cores"
        type="number"
        [label]="'Cores' | translate"
        [tooltip]="'Number of cores per socket' | translate"
      ></ix-input>

      <ix-input
        formControlName="threads"
        type="number"
        [label]="'Threads' | translate"
        [tooltip]="'Number of threads per core' | translate"
      ></ix-input>

      <ix-input
        formControlName="cpuset"
        [label]="'CPU Set' | translate"
        [tooltip]="'List of physical CPU numbers to bind container to (e.g., 0-3,5)' | translate"
      ></ix-input>
    </ix-form-section>

    <ix-form-section
      [label]="'Memory' | translate"
    >
      <ix-input
        formControlName="memory"
        type="number"
        [label]="'Memory Size (MB)' | translate"
        [tooltip]="'Memory available to container in megabytes' | translate"
      ></ix-input>
    </ix-form-section>

    <ix-form-section
      [label]="'Time Configuration' | translate"
    >
      <ix-select
        formControlName="time"
        [label]="'Container Time' | translate"
        [options]="timeOptions$"
        [tooltip]="'Whether container time should be local time or UTC time' | translate"
      ></ix-select>

      <ix-input
        formControlName="shutdown_timeout"
        type="number"
        [label]="'Shutdown Timeout (seconds)' | translate"
        [tooltip]="'How many seconds to wait for container to shut down before killing it' | translate"
      ></ix-input>
    </ix-form-section>

    <ix-form-section
      [label]="'Init Process' | translate"
    >
      @if (!isEditMode()) {
        <ix-input
          formControlName="init"
          [label]="'Init Process' | translate"
          [tooltip]="'Init process command line' | translate"
        ></ix-input>
      }

      <ix-input
        formControlName="initdir"
        [label]="'Init Working Directory' | translate"
        [tooltip]="'Init process working directory' | translate"
      ></ix-input>

      <ix-input
        formControlName="inituser"
        [label]="'Init User' | translate"
        [tooltip]="'Init process username' | translate"
      ></ix-input>

      <ix-input
        formControlName="initgroup"
        [label]="'Init Group' | translate"
        [tooltip]="'Init process group' | translate"
      ></ix-input>
    </ix-form-section>

    <ix-form-section
      [label]="'Environment Variables' | translate"
    >
      <ix-list
        formArrayName="environment_variables"
        [empty]="form.controls.environment_variables.controls.length === 0"
        [label]="'Environment Variables' | translate"
        (add)="addEnvironmentVariable()"
      >
        @for (envControl of form.controls.environment_variables.controls; track envControl; let i = $index) {
          <ix-list-item
            [formGroupName]="i"
            [label]="'Environment Variable' | translate"
            (delete)="removeEnvironmentVariable(i)"
          >
            <div class="environment-variable">
              <ix-input
                formControlName="name"
                [label]="'Name' | translate"
                [required]="true"
              ></ix-input>

              <ix-input
                formControlName="value"
                [label]="'Value' | translate"
                [required]="true"
              ></ix-input>
            </div>
          </ix-list-item>
        }
      </ix-list>
    </ix-form-section>

    <ix-form-section
      [label]="'Capabilities' | translate"
    >
      <ix-select
        formControlName="capabilities_policy"
        [label]="'Capabilities Policy' | translate"
        [options]="capabilitiesPolicyOptions$"
        [hideEmpty]="true"
        [tooltip]="'Default rules for capabilities: DEFAULT (keep default behavior), ALLOW (drop all capabilities), or DENY (keep all capabilities)' | translate"
      ></ix-select>
    </ix-form-section>

    <!-- Storage section hidden until API support is available -->
    <!-- <ix-form-section [label]="'Storage' | translate">
      ...
    </ix-form-section> -->

    <!-- Proxies section hidden until API support is available -->
    <!-- <ix-form-section [label]="'Proxies' | translate">
      ...
    </ix-form-section> -->

    <!-- Network section hidden until API support is available -->
    <!-- <ix-form-section [label]="'Network' | translate">
      ...
    </ix-form-section> -->

    <!-- USB Devices section hidden until API support is available -->
    <!-- @let usbDevices = usbDevices$ | async;
    @if (usbDevices && usbDevices.length > 0) {
      <ix-form-section [label]="'USB Devices' | translate">
        ...
      </ix-form-section>
    } -->

    <!-- GPU Devices section hidden until API support is available -->
    <!-- @let gpuDevices = gpuDevices$ | async;
    @if (gpuDevices && gpuDevices.length > 0) {
      <ix-form-section [label]="'GPU Devices' | translate">
        ...
      </ix-form-section>
    } -->

    <div class="actions">
      <button
        mat-button
        type="submit"
        color="primary"
        [ixTest]="isEditMode() ? 'save' : 'create'"
        [disabled]="form.invalid || isLoading()"
      >
        {{ submitButtonText() }}
      </button>
    </div>
  </form>
  <ix-form-glossary class="glossary"></ix-form-glossary>
</div>
